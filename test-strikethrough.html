<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Test Strikethrough on Multiple Instances</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 800px; }
    .test { margin: 20px 0; padding: 15px; border: 2px solid #ddd; background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Test Multiple Instances</h1>

  <div class="test">
    <h3>Test Text (should have strikethrough on "test word" everywhere)</h3>
    <article>
      <p>This is a test word that appears multiple times.</p>
      <p>Here's another test word in a different paragraph.</p>
      <p>And one more test word just to be sure.</p>
      <p>BEGIN_WORDCOUNT_EXCLUSION
test word
END_WORDCOUNT_EXCLUSION</p>
    </article>
  </div>

  <div id="debug"></div>

  <script>
    function escHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function highlightExcluded(s, exclusionTexts){
      var result = escHtml(s);
      console.log('Original escaped:', result);

      if(exclusionTexts.length){
        exclusionTexts.forEach(function(excl, idx){
          var pattern = escHtml(excl).replace(/[.*+?^${}()|[\]\\]/g,'\\$&').replace(/\s+/g,'\\s+');
          console.log('Exclusion', idx, ':', excl);
          console.log('Pattern:', pattern);

          var regex = new RegExp(pattern,'gi');
          var matches = result.match(regex);
          console.log('Matches found:', matches ? matches.length : 0, matches);

          result = result.replace(regex,'<span style="color:#d32f2f;text-decoration:line-through;">$&</span>');
        });
      }

      return result.replace(/\n\n/g,'<br><span style="display:block;height:0.6em"></span>')
                   .replace(/\n/g,'<br>');
    }

    // Test
    var text = "This is a test word that appears multiple times.\n\nHere's another test word in a different paragraph.\n\nAnd one more test word just to be sure.";
    var exclusions = ["test word"];

    var output = highlightExcluded(text, exclusions);
    document.getElementById('debug').innerHTML = '<h3>Output:</h3><div style="border:1px solid #ccc;padding:10px;background:#f5f5f5">' + output + '</div>';
  </script>
</body>
</html>
