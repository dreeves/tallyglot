<!DOCTYPE html>
<html>
<head>
  <title>Final Test v2</title>
  <script>
    function testExtraction() {
      const source = document.getElementById('source');
      const c = source.cloneNode(true);
      
      // Remove unwanted
      c.querySelectorAll('script,style,nav,footer,header,iframe').forEach(x => x.remove());
      
      // Add newlines - NEW LOGIC
      const blocks = c.querySelectorAll('p,div,h1,h2,h3,h4,h5,h6');
      blocks.forEach((el, i) => {
        if (i < blocks.length - 1) el.insertAdjacentText('afterend', '\n\n');
        else el.insertAdjacentText('afterend', '\n');
      });
      c.querySelectorAll('br,li,td,th').forEach(el => {
        const tag = el.tagName.toLowerCase();
        if (tag === 'br') el.textContent = '\n';
        else el.insertAdjacentText('afterend', '\n');
      });
      
      const extracted = c.innerText || c.textContent;
      
      // Sanitize
      let sanitized = extracted;
      sanitized = sanitized.replace(/\r\n?/g, '\n');
      sanitized = sanitized.replace(/[ \t\f\v]+/g, ' ');
      sanitized = sanitized.replace(/[ \t\f\v]*\n[ \t\f\v]*/g, '\n');
      sanitized = sanitized.replace(/\n{3,}/g, '\n\n');
      
      // Display
      document.getElementById('output').textContent = sanitized;
      
      // Debug
      document.getElementById('debug').textContent = 
        'Extracted: ' + JSON.stringify(extracted) + 
        '\n\nSanitized: ' + JSON.stringify(sanitized) +
        '\n\nExpected: Para breaks between paragraphs, single line break within';
    }
  </script>
</head>
<body>
  <h2>Source</h2>
  <div id="source" contenteditable="true">
    <p>First paragraph.</p>
    <p>Second paragraph.</p>
    <p>Line within<br>continues.</p>
  </div>
  
  <button onclick="testExtraction()">Test</button>
  
  <h2>Output (white-space:pre-wrap)</h2>
  <div id="output" style="white-space:pre-wrap;background:#f5f5f5;padding:8px;border:1px solid #ccc;font-family:monospace;"></div>
  
  <h2>Debug</h2>
  <pre id="debug" style="background:#eee;padding:8px;font-size:11px;"></pre>
</body>
</html>