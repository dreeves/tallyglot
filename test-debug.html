<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Debug Line Breaks</title>
  <style>
    body { font-family: sans-serif; margin: 20px; max-width: 900px; }
    .stage { margin: 20px 0; padding: 15px; border: 2px solid #ddd; background: #f9f9f9; }
    .stage h3 { margin-top: 0; color: #1976D2; }
    .output {
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .visual {
      background: #f5f5f5;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 10px;
      font-family: monospace;
      font-size: 11px;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <h1>Debug: Line Breaks vs Paragraph Breaks</h1>

  <article id="test-content">
    <p>Line one<br />
Line two<br />
Line three</p>
    <p>Second paragraph</p>
  </article>

  <div class="stage">
    <h3>Stage 1: Original HTML</h3>
    <div class="output" id="stage1"></div>
  </div>

  <div class="stage">
    <h3>Stage 2: After placeholder replacement</h3>
    <div class="output" id="stage2"></div>
  </div>

  <div class="stage">
    <h3>Stage 3: After innerText extraction</h3>
    <div class="output" id="stage3"></div>
  </div>

  <div class="stage">
    <h3>Stage 4: After placeholder→newline conversion</h3>
    <div class="output" id="stage4"></div>
  </div>

  <div class="stage">
    <h3>Stage 5: After sanitize()</h3>
    <div class="output" id="stage5"></div>
  </div>

  <div class="stage">
    <h3>Stage 6: Visual rendering (what popup shows)</h3>
    <div class="visual" id="stage6"></div>
  </div>

  <script>
    function sanitize(s){
      s=String(s??'');
      if(s.normalize)s=s.normalize('NFC');
      s=s.replace(/\r\n?/g,'\n');
      s=s.replace(/[\u00AD\u200B\u2060\uFEFF\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'');
      s=s.replace(/[\u2028\u2029]/g,'\n');
      s=s.replace(/[\u00A0\u1680\u2000-\u200A\u202F\u205F\u3000]/g,' ');
      s=s.replace(/[ \t\f\v]+/g,' ');
      s=s.replace(/[ \t\f\v]*\n[ \t\f\v]*/g,'\n');
      s=s.replace(/\n{3,}/g,'\n\n');
      return s;
    }

    function escHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function formatLineBreaks(s){
      return s.replace(/\n\n/g,'<br><span style="display:block;height:0.6em;background:#ffeb3b"></span>')
              .replace(/\n/g,'<br>');
    }

    // Stage 1: Original HTML
    const el = document.getElementById('test-content');
    document.getElementById('stage1').textContent = el.innerHTML;

    // Stage 2: Clone and replace with placeholders
    const c = el.cloneNode(true);
    c.querySelectorAll('script,style,nav,footer,header,iframe').forEach(x => x.remove());
    c.querySelectorAll('br').forEach(br => {
      const tn = document.createTextNode('¶BR¶');
      br.parentNode.replaceChild(tn, br);
    });
    c.querySelectorAll('p,div,h1,h2,h3,h4,h5,h6,li,td,th').forEach(el => {
      el.insertAdjacentText('afterend', '¶PARA¶');
    });
    document.getElementById('stage2').textContent = c.innerHTML;

    // Stage 3: innerText extraction
    let bodyText = c.innerText || c.textContent;
    document.getElementById('stage3').textContent = JSON.stringify(bodyText);

    // Stage 4: Convert placeholders
    bodyText = bodyText.replace(/¶BR¶/g,'\n').replace(/¶PARA¶/g,'\n\n');
    document.getElementById('stage4').textContent = JSON.stringify(bodyText);

    // Stage 5: After sanitize
    const sanitized = sanitize(bodyText).trim();
    document.getElementById('stage5').textContent = JSON.stringify(sanitized);

    // Stage 6: Visual rendering
    document.getElementById('stage6').innerHTML = formatLineBreaks(escHtml(sanitized));
  </script>
</body>
</html>
